{% extends "base.html" %}

{% if business_item %}
    {% block title %}{{business_item.name}}{% endblock %}
    
    {% block page_name %}{{business_item.name}}{% endblock %}

    {% block content %}
    
    <div class="span-12" id="business_props">
        <h2>Address</h2>
        <ul class="boxed_list">
            <li>{{business_item.address1}}<br/>
                {{ business_item.address2 }}<br/>
                {{ business_item.city }}, {{ business_item.province }}, {{ business_item.country }}<br/>
                {{ business_item.zipcode }}<br/>
            </li>
        </ul>
        <h2>Contact Number</h2>
        <ul class="boxed_list">
        {% for phone in phone_list %}
            <li>{{phone.phone_number}}</li>
        {% endfor %}
        </ul>
        
        <div class="buttons">
            <a href="/review/add/{{business_item.id}}" class="button"><img src="/images/icons/add.png" alt=""/> <span>Add Review</span></a> 
            <a href="/review/add/{{business_item.id}}" class="button"><img src="/images/icons/image_add.png" alt=""/> <span>Add Photos</span></a> 
        </div>
        <h2>Reviews</h2>
        <ul class="boxed_list">
        {% for review in reviews %}
            <li>{{review.review}} ({{review.created_at}})</li>
        {% endfor %}
        </ul>
    </div>
    
    <div class="span-12 last ">
        <div id="map_canvas" style="width: 475px; height: 300px"></div>
        <div id="map_message"></div>
        <div id="searchwell"></div> 
        <script type="text/javascript">
        //<![CDATA[
        $(document).ready(function() {
            // do stuff when DOM is ready
            var geocoder = new google.maps.Geocoder();
            var address = '{{string_location}}';
            var business_name = '{{business_item.name}}';
            var map;
        
            // Our global state for LocalSearch
            var gInfoWindow;
            var gSelectedResults = [];
            var gCurrentResults = [];
            var gLocalSearch = new GlocalSearch();
            var localSearchCenter = "{{business_item.city}}, {{business_item.province}}, {{business_item.country}}, {{business_item.zipcode}}";
        
            if (geocoder) {
                geocoder.geocode({ 'address': address }, function (results, status) {
                    if (status == google.maps.GeocoderStatus.OK) {
                        //alert(results[0].geometry.location.lat())
                        //alert(results[0].geometry.location.lng())
        
                        //Create the Map and center to geocode results latlong
                        var latlng = new google.maps.LatLng(results[0].geometry.location.lat(), results[0].geometry.location.lng());
                        var myOptions = {
                            zoom: 13,
                            center: latlng,
                            mapTypeId: google.maps.MapTypeId.ROADMAP
                        };
        
                        map = new google.maps.Map(document.getElementById("map_canvas"),
                            myOptions);
                        
                        gLocalSearch.setCenterPoint(localSearchCenter);
                        gLocalSearch.setSearchCompleteCallback(this, OnLocalSearch);
                        
                        gLocalSearch.execute(business_name);
                        console.log("string_location: {{string_location}}");
                    } 
                    else {
                        alert('No results found. Check console.log()');
                        console.log("Geocoding address: " + address);
                        console.log("Geocoding failed: " + status);
                    }
                });
            }
        
            /*
            Other functions        
            */        
            function OnLocalSearch() {
                console.log("results: "+gLocalSearch.results);
                console.log("results length: "+gLocalSearch.results.length);
                
                if (gLocalSearch.results[0]) { //This is empty. Why?
                    $.each(gLocalSearch.results, function(i, n){
                        console.log("result ["+i+"]: "+n);
                        $.each(n, function(j, k) {
                            console.log(" > result ["+j+"]: "+k);
                            
                            var marker = new google.maps.Marker({
                                position: new google.maps.LatLng(gLocalSearch.results[i].lat,gLocalSearch.results[i].lng), 
                                map: map, 
                                title: gLocalSearch.results[i].streetAddress,
                            });
                        });
                    });
                    
                    // Move the map to the first result
                    //var first = gLocalSearch.results[0];
                    //map.setCenter(new google.maps.LatLng(parseFloat(gLocalSearch.results[0].lat),
                    //                                     parseFloat(gLocalSearch.results[0].lng)));
                    //callbackFunction(point); 
                }else{ 
                    alert("business name not found!"); 
                } 
            }
        });
        //]]>
        </script>
        
    </div>
    
    {% endblock %}
{% else %}
    No business available.
{% endif %} 