{% extends "base.html" %}

{% if business_item %}
    {% block title %}{{business_item.name}}{% endblock %}
    
    {% block page_name %}{{business_item.name}}{% endblock %}

    {% block content %}
    
    <div class="span-12" id="business_props">
        <h2>Address</h2>
        <ul class="boxed_list">
            <li>{{business_item.address1}}<br/>
                {{ business_item.address2 }}<br/>
                {{ business_item.city }}, {{ business_item.province }}, {{ business_item.country }}<br/>
                {{ business_item.zipcode }}<br/>
            </li>
        </ul>
        <h2>Contact Number</h2>
        <ul class="boxed_list">
        {% for phone in phone_list %}
            <li>{{phone.phone_number}}</li>
        {% endfor %}
        </ul>
        
        <div class="buttons">
            <a href="/review/add/{{business_item.id}}" class="button"><img src="/images/icons/add.png" alt=""/> <span>Add Review</span></a> 
            <a href="/review/add/{{business_item.id}}" class="button"><img src="/images/icons/image_add.png" alt=""/> <span>Add Photos</span></a> 
        </div>
        <h2>Reviews</h2>
        <ul class="boxed_list">
        {% for review in reviews %}
            <li>{{review.review}} ({{review.created_at}})</li>
        {% endfor %}
        </ul>
    </div>
    
    <div class="span-12 last ">
        <img src="http://labs.google.com/ridefinder/images/mm_20_red.png" /> = Matches the business name<br/>
        <img src="http://labs.google.com/ridefinder/images/mm_20_yellow.png" /> = Area of interest
        
        <div id="map_canvas" style="width: 475px; height: 300px"></div>
        <div id="map_message"></div>
        <div id="searchwell"></div> 
        <script type="text/javascript">
        //<![CDATA[
        //@ http://jsfromhell.com/string/soundex [v1.0]
        String.prototype.soundex = function(p){ //v1.0
            var i, j, r, p = isNaN(p) ? 4 : p > 10 ? 10 : p < 4 ? 4 : p,
            m = {BFPV: 1, CGJKQSXZ: 2, DT: 3, L: 4, MN: 5, R: 6},
            r = (s = this.toUpperCase().replace(/[^A-Z]/g, "").split("")).splice(0, 1);
            for(i in s)
                for(j in m)
                    if(j.indexOf(s[i]) + 1 && r[r.length-1] != m[j] && r.push(m[j]))
                        break;
            return r.length > p && (r.length = p), r.join("") + (new Array(p - r.length + 1)).join("0");
        };
        
        $(document).ready(function() {
            // do stuff when DOM is ready
            var geocoder = new google.maps.Geocoder();
            var address = '{{string_location}}';
            var business_name = '{{business_item.name}}';
            var map;
        
            // Create our "tiny" marker icon
            var gYellowIcon = new google.maps.MarkerImage(
                "http://labs.google.com/ridefinder/images/mm_20_yellow.png",
                new google.maps.Size(12, 20),
                new google.maps.Point(0, 0),
                new google.maps.Point(6, 20));
            var gRedIcon = new google.maps.MarkerImage(
                "http://labs.google.com/ridefinder/images/mm_20_red.png",
                new google.maps.Size(12, 20),
                new google.maps.Point(0, 0),
                new google.maps.Point(6, 20));
            var gSmallShadow = new google.maps.MarkerImage(
                "http://labs.google.com/ridefinder/images/mm_20_shadow.png",
                new google.maps.Size(22, 20),
                new google.maps.Point(0, 0),
                new google.maps.Point(6, 20));
            
            // Our global state for LocalSearch
            var gLocalSearch = new GlocalSearch();
            var localSearchCenter = "{{business_item.city}}, {{business_item.province}}, {{business_item.country}}, {{business_item.zipcode}}";
        
            if (geocoder) {
                geocoder.geocode({ 'address': address }, function (results, status) {
                    if (status == google.maps.GeocoderStatus.OK) {
                        //alert(results[0].geometry.location.lat())
                        //alert(results[0].geometry.location.lng())
        
                        //Create the Map and center to geocode results latlong
                        var latlng = new google.maps.LatLng(results[0].geometry.location.lat(), results[0].geometry.location.lng());
                        var myOptions = {
                            zoom: 13,
                            center: latlng,
                            mapTypeId: google.maps.MapTypeId.ROADMAP
                        };
        
                        map = new google.maps.Map(document.getElementById("map_canvas"),
                            myOptions);
                        
                        gLocalSearch.setCenterPoint(localSearchCenter);
                        gLocalSearch.setSearchCompleteCallback(this, OnLocalSearch);
                        
                        gLocalSearch.execute(business_name);
                        console.log("string_location: {{string_location}}");
                    } 
                    else {
                        alert('No results found. Check console.log()');
                        console.log("Geocoding address: " + address);
                        console.log("Geocoding failed: " + status);
                    }
                });
            }
        
            /*
            Other functions        
            */        
            function OnLocalSearch() {
                var results = gLocalSearch.results;
                var centerNewLat = 0;
                var centerNewLng = 0;
                console.log("results: "+gLocalSearch.results);
                console.log("results length: "+ results.length);
                
                //alert("business_name.soundex(): "+business_name.soundex()+" results[1].titleNoFormatting: "+results[0].titleNoFormatting.soundex());
                
                if (results[0]) {
                    $.each(results, function(i, n){
                        console.log("result ["+i+"]: "+n);
                        if ((business_name.soundex() == results[i].titleNoFormatting.soundex())) {
                            //alert("business_name.soundex(): "+business_name.soundex()+" results.titleNoFormatting: "+results[i].titleNoFormatting.soundex());
                            var marker = new google.maps.Marker({
                                position: new google.maps.LatLng(results[i].lat,results[i].lng), 
                                map: map, 
                                title: results[i].streetAddress,
                                icon: gRedIcon,
                                shadow: gSmallShadow
                            });
                            centerNewLat = results[i].lat;
                            centerNewLng = results[i].lng;
                        } else {
                            var marker = new google.maps.Marker({
                                position: new google.maps.LatLng(results[i].lat,results[i].lng), 
                                map: map, 
                                title: results[i].streetAddress,
                                icon: gYellowIcon,
                                shadow: gSmallShadow
                            });
                        }
                        
                        
                        $.each(n, function(j, k) {
                            console.log(" > result ["+j+"]: "+k);
                        });
                        
                    });
                    
                    // Move the map to the first result
                    //var first = gLocalSearch.results[0];
                    if(centerNewLat != 0 && centerNewLng != 0) {
                        map.setCenter(new google.maps.LatLng(parseFloat(centerNewLat),
                                                         parseFloat(centerNewLng)));
                    } else {
                        map.setCenter(new google.maps.LatLng(parseFloat(results[0].lat),
                                                         parseFloat(results[0].lng)));
                    }
                    
                    //callbackFunction(point); 
                }else{ 
                    alert("business name not found!"); 
                } 
            }
            
        });
        //]]>
        </script>
        
    </div>
    
    {% endblock %}
{% else %}
    No business available.
{% endif %} 